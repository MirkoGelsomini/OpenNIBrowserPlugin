

<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>three.js - kinect</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				font-family: Monospace;
				background-color: #000000;
				margin: 0px;
				overflow: hidden;
			}
		</style>
	</head>
	<body>
	    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.5/jquery-ui.min.js"></script>


		<script src="Detector.js"></script>
		<script src="RequestAnimationFrame.js"></script>
		<script src="Stats.js"></script>
		<script src="Three.js"></script>

		<script id="vs" type="x-shader/x-vertex">

			uniform sampler2D map;

			uniform float width;
			uniform float height;
			uniform float nearClipping, farClipping;

			varying vec2 vUv;

			const float XtoZ = 1.11146; // tan( 1.0144686 / 2.0 ) * 2.0;
			const float YtoZ = 0.83359; // tan( 0.7898090 / 2.0 ) * 2.0;

			void main() {

				vUv = vec2( position.x / width, 1.0 - ( position.y / height ) );

				vec4 color = texture2D( map, vUv );
				//float depth = ( color.r + color.g + color.b ) / 3.0;
				
				// Projection code by @kcmic

				//float z = ( 1.0 - depth ) * (farClipping - nearClipping) + nearClipping;

				// maxdepth is 10000, encoding LSB in R and MSB in G
				float z = ( color.r + (color.g * 256.0) ) * 256.0;

				
				vec4 pos = vec4(
					( position.x / width - 0.5 ) * z * XtoZ,
					( position.y / height - 0.5 ) * z * YtoZ,
					- z + 1000.0,
					1.0);

				gl_PointSize = 2.0;
				gl_Position = projectionMatrix * modelViewMatrix * pos;

			}

		</script>

		<script id="fs" type="x-shader/x-fragment">

			uniform sampler2D map;

			varying vec2 vUv;

			void main() {

				vec4 color = texture2D( map, vUv );
				//gl_FragColor = vec4( 1.0 - (abs(color.r - 0.5) * 2), color.g * 6, color.b, smoothstep( 8000.0, -8000.0, gl_FragCoord.z / gl_FragCoord.w ) );
				float val = color.r;
				//gl_FragColor = vec4( abs(color.r - 0.5) * 2.0, (color.g * 6.0), 1.0 - (abs(color.r - 0.5) * 2.0) , smoothstep( 8000.0, -8000.0, gl_FragCoord.z / gl_FragCoord.w ) );
				gl_FragColor = vec4( abs(color.r - 0.5) * 2.0, ceil(color.b), 1.0 - (abs(color.r - 0.5) * 2.0) , smoothstep( 8000.0, -8000.0, gl_FragCoord.z / gl_FragCoord.w ) );

			}

		</script>

		<script>

			var container;

			var scene, camera, light, renderer;
			var geometry, cube, mesh, material;
			var mouse, center;
			var stats;

			var video, texture;

			if ( Detector.webgl ) {

				init();
				animate();

			} else {

				document.body.appendChild( Detector.getWebGLErrorMessage() );

			}

			function init() {

				container = document.createElement( 'div' );
				document.body.appendChild( container );

				stats = new Stats();
				stats.domElement.style.position = 'absolute';
				stats.domElement.style.top = '0px';
				container.appendChild( stats.domElement );

				scene = new THREE.Scene();
				center = new THREE.Vector3();
				center.z = - 1000;

				camera = new THREE.PerspectiveCamera( 50, window.innerWidth / window.innerHeight, 1, 10000 );
				camera.position.set( 0, 0, 500 );
				scene.add( camera );

				texture = new THREE.Texture( new Image() );
				texture.minFilter = THREE.NearestFilter;
				texture.magFilter = THREE.NearestFilter;

				var width = 320, height = 240;
				//var nearClipping = 850/*850*/, farClipping = 4000/*4000*/;
				var nearClipping = 0/*850*/, farClipping = 10000/*4000*/;

				geometry = new THREE.Geometry();

				for ( var i = 0, l = width * height; i < l; i ++ ) {

					var position = new THREE.Vector3();
					position.x = ( i % width );
					position.y = Math.floor( i / width );

					geometry.vertices.push( new THREE.Vertex( position ) );

				}

				material = new THREE.ShaderMaterial( {

					uniforms: {

						"map": { type: "t", value: 0, texture: texture },
						"width": { type: "f", value: width },
						"height": { type: "f", value: height },
						"nearClipping": { type: "f", value: nearClipping },
						"farClipping": { type: "f", value: farClipping }

					},
					vertexShader: document.getElementById( 'vs' ).textContent,
					fragmentShader: document.getElementById( 'fs' ).textContent,
					depthWrite: false

				} );

				mesh = new THREE.ParticleSystem( geometry, material );
				mesh.position.x = 0;
				mesh.position.y = 0;
				scene.add( mesh );
				


				renderer = new THREE.WebGLRenderer();
				renderer.setSize( window.innerWidth, window.innerHeight );
				container.appendChild( renderer.domElement );

				mouse = new THREE.Vector3( 0, 0, 1 );
				projector = new THREE.Projector();
				ray = new THREE.Ray( camera.position );

				document.addEventListener( 'mousemove', onDocumentMouseMove, false );

			}

			function onDocumentMouseMove( event ) {

				mouse.x = ( event.clientX - window.innerWidth / 2 ) * 8;
				mouse.y = ( event.clientY - window.innerHeight / 2 ) * 8;

			}

			function animate() {

				requestAnimationFrame( animate );

				render();
				stats.update();

			}

			function render() {

				camera.position.x += ( mouse.x - camera.position.x ) * 0.05;
				camera.position.y += ( - mouse.y - camera.position.y ) * 0.05;
				camera.lookAt( center );

				renderer.render( scene, camera );

			}

// My code
		var mimeType = "application/x-zig";
        var pluginCB = null;
		
        function plugin() {
            return document.getElementById("testPlugin");
        }

        function injectPlugin(dest, callback) {
            pluginCB = callback;
            var html = '<object id="testPlugin" type="' + mimeType + '" width="100%" height="100%" onload="alert(\'The plugin has loaded 1!\');">';
            html += '<param name="onload" value="pluginCB" />';
            html += '</object>';
            dest[0].innerHTML = html;
        }
		
        function pageLoaded() {
            injectPlugin($("#pluginContainer"), pluginLoaded);
        }
		
 
        function pluginLoaded() {
			
			plugin().setImage(new Image());
			plugin().addEventListener("NewFrame", function() { 
				var img2 = new Image();
				img2.onload = (function() { return function() {
					img2.onload = null; //break reference loop
					if (texture) {
						texture.image = img2;
						texture.needsUpdate = true; 
					}
				} })();
				plugin().setImage(img2);
			}, false);
			superP = plugin();
			setInterval(function() { superP.update() }, 30);
        }

	
        $(document).ready(pageLoaded);

		</script>
		
		<div id="pluginContainer" style="{display:none}">
        
		</div>
	</body>
</html>
